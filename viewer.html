{% extends "base.html" %}
{% block content %}

<div class="flex flex-col md:flex-row gap-6 p-6">

    <!-- Left Column: Current Player -->
    <div class="flex flex-col w-full md:w-2/3 gap-4">

        <!-- Current Player -->
        <div class="glass-card p-6 rounded-2xl neon-border shadow-2xl text-center">
            <div id="current-player" class="mb-4">
                <p class="text-purple-300">Auction not started</p>
            </div>
        </div>

        <!-- 4-Column Team Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="team-grid">
            <!-- JS will populate -->
        </div>

    </div>

    <!-- Right Column: Videos -->
    <div class="flex flex-col w-full md:w-1/3 gap-4">

        <!-- Videos -->
        <div class="glass-card p-4 rounded-xl neon-border shadow-lg">
            <h3 class="text-xl gold-text mb-2">Highlights</h3>
            <div class="flex flex-col gap-2">
                <video src="https://playerimages-1.s3.us-east-1.amazonaws.com/WhatsApp+Video+2025-11-17+at+12.15.49+AM.mp4" autoplay loop muted class="rounded-lg w-full shadow-lg"></video>
                <video src="https://playerimages-1.s3.us-east-1.amazonaws.com/WhatsApp+Video+2025-11-17+at+12.15.49+AM.mp4" autoplay loop muted class="rounded-lg w-full shadow-lg"></video>
            </div>
        </div>

    </div>

</div>

<script>
async function updateViewerState() {
    const res = await fetch("/live_state");
    const data = await res.json();

    // Current Player Panel
    const cpDiv = document.getElementById("current-player");
    const cp = data.current_player;
    if(cp){
        cpDiv.innerHTML = `
            <img src="/static/images/${cp.image}" class="mx-auto rounded-lg w-2/3 mb-2 neon-border shadow-xl">
            <p class="text-lg gold-text font-bold">${cp.name} (${cp.role})</p>
            <p class="text-purple-300">Base Price: ₹${cp.base_price}</p>
            <p class="text-purple-300">Highest Bid: ₹${data.state.highest_bid || cp.base_price}</p>
            <p class="text-purple-300">Highest Bidder: ${data.state.highest_bidder || '-'}</p>
        `;
    } else {
        cpDiv.innerHTML = '<p class="text-purple-300">Auction not started</p>';
    }

    // Unified Team Cards (4 column layout)
    const teamGrid = document.getElementById("team-grid");
    teamGrid.innerHTML = '';

    (data.teams || []).forEach(team => {
        const soldPlayers = (data.players || []).filter(p => p.sold_to === team.team_name);

        let soldHtml = soldPlayers.length
            ? soldPlayers.map(p => 
                `<p class="text-purple-300 text-sm ml-1">• ${p.name} — ₹${p.final_price}</p>`
              ).join("")
            : `<p class="text-purple-400 text-sm">No players yet</p>`;

        teamGrid.innerHTML += `
            <div class="glass-card p-4 rounded-xl neon-border shadow-xl">
                <p class="gold-text font-bold text-lg">${team.team_name}</p>
                <p class="text-purple-200 mb-2">Purse Left: ₹${team.purse}</p>

                <p class="text-purple-200 font-semibold">Players Bought:</p>
                <div class="mt-1">${soldHtml}</div>
            </div>
        `;
    });
}

// Poll every second
setInterval(updateViewerState, 1000);
updateViewerState();
</script>

{% endblock %}
